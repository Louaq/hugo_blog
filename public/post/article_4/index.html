<!doctype html>
<html
  lang="zh-cn"
  
>
  <head><script src="/hugo_blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=hugo_blog/livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/>







  

<title>
  YOLOv8文件分析 | Louaq
</title>
<meta
  name="description"
  content="少女祈祷中..."
/>










<script>
  window.siteConfig = JSON.parse("{\"anchor_icon\":null,\"clipboard\":{\"copyright\":{\"content\":\"本文版权：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处！\",\"count\":50,\"enable\":false},\"fail\":\"复制失败 (ﾟ⊿ﾟ)ﾂ\",\"success\":\"复制成功(*^▽^*)\"},\"code_block\":{\"expand\":10},\"icon_font\":\"4552607_tq6stt6tcg\",\"outdate\":{\"daysago\":20,\"enable\":true,\"message\":\"本文最后更新于 {time}，请注意文中内容可能已经发生变化。\"}}");
</script>











  
  
  
    
  

  
  
  
    
  

  
    

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  rel="preload"
  as="style"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"
/>
<link
  rel="stylesheet"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"
  media="print"
  onload="this.media='all'"
/>






  <link
    rel="preload"
    href="//at.alicdn.com/t/c/font_4552607_tq6stt6tcg.woff2"
    as="font"
    type="font/woff2"
    crossorigin="anonymous"
  />



  






 <link rel="stylesheet" href="/hugo_blog/css/loader.css" />




  <meta property="og:type" content="website" />
  <meta property="og:title" content="YOLOv8文件分析 | Louaq" />
  <meta
    property="og:description"
    content="少女祈祷中..."
  />
  <meta property="og:url" content="http://localhost:1313/hugo_blog/post/article_4/" />
  <meta
    property="og:site_name"
    content="Louaq lab"
  />
  <meta
    property="og:image"
    content="https://yangyang666.oss-cn-chengdu.aliyuncs.com/images/Fragment_9_4k_b0d62.jpg"
  />
  <meta property="article:author" content="Louaq" />
  <meta property="article:published_time" content="2024-08-19T12:00:00&#43;00:00" />
  <meta property="article:modified_time" content="2024-08-19T12:00:00&#43;00:00" />
  
  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:image" content="https://yangyang666.oss-cn-chengdu.aliyuncs.com/images/Fragment_9_4k_b0d62.jpg" />
  
  
  
  
  




<link rel="shortcut icon" href="/hugo_blog/favicon.ico">







 <link rel="stylesheet" href="/hugo_blog/css/main.css" />





  <link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css"
    onload="this.onload=null;this.rel='stylesheet'"
  />






  <link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/katex@0.16.9/dist/katex.min.css"
    onload="this.onload=null;this.rel='stylesheet'"
  />








  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js"
    
    
    
    
    integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"
  ></script>





  


  <link rel="stylesheet" href="https://npm.webcache.cn/@reimujs/aos@0.1.0/dist/aos.css" />





  </head>
  <body>
    
  <div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi">
        
          <svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="https://www.w3.org/2000/svg" shape-rendering="geometricPrecision">
            <path d="M303.5 432A80 80 0 0 1 291.5 592A80 80 0 0 1 303.5 432z" fill="#ff5252" />
            <path d="M512 65A447 447 0 0 1 512 959L512 929A417 417 0 0 0 512 95A417 417 0 0 0 512 929L512 959A447 447 0 0 1 512 65z 
          M512 95A417 417 0 0 1 929 512A208.5 208.5 0 0 1 720.5 720.5L720.5 592A80 80 0 0 0 720.5 432A80 80 0 0 0 720.5 592L720.5 720.5A208.5 208.5 0 0 1 512 512A208.5 208.5 0 0 0 303.5 303.5A208.5 208.5 0 0 0 95 512A417 417 0 0 1 512 95z" fill="#ff5252" />
          </svg>
        
      </div>
      <div class="loading-word">少女祈祷中...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var startLoading = () => {
      time = Date.now();
      document.getElementById('loader').classList.remove("loading");
    }
    var endLoading = () => {
      if (!time) {
        document.body.style.overflow = 'auto';
        document.getElementById('loader').classList.add("loading");
      } else {
        if (Date.now() - time > 500) {
          time = null;
          document.body.style.overflow = 'auto';
          document.getElementById('loader').classList.add("loading");
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    document.getElementById('loader').addEventListener('click', endLoading);
  </script>


<div id="copy-tooltip" style="pointer-events: none; opacity: 0; transition: all 0.2s ease; position: fixed;top: 50%;left: 50%;z-index: 999;transform: translate(-50%, -50%);color: white;background: rgba(0, 0, 0, 0.5);padding: 10px 15px;border-radius: 10px;">
</div>


    <div id="container">
      <div id="wrap">
        
<div id="header-nav">
  <nav id="main-nav">
    
      <span class="main-nav-link-wrap">
        <div class='main-nav-icon icon rotate'>
          
            
              &#xe62b;
            
          
        </div>
        <a class="main-nav-link" href="/hugo_blog/">首页</a>
      </span>
    
      <span class="main-nav-link-wrap">
        <div class='main-nav-icon icon rotate'>
          
            
              &#xe62b;
            
          
        </div>
        <a class="main-nav-link" href="/hugo_blog/archives">归档</a>
      </span>
    
      <span class="main-nav-link-wrap">
        <div class='main-nav-icon icon rotate'>
          
            
              &#xe62b;
            
          
        </div>
        <a class="main-nav-link" href="/hugo_blog/about">关于</a>
      </span>
    
      <span class="main-nav-link-wrap">
        <div class='main-nav-icon icon rotate'>
          
            
              &#xe62b;
            
          
        </div>
        <a class="main-nav-link" href="/hugo_blog/friend">友链</a>
      </span>
    
    <a id="main-nav-toggle" class="nav-icon"></a>
  </nav>
  <nav id="sub-nav">
    
    
      <a id="nav-search-btn" class="nav-icon popup-trigger" title="搜索"></a>
    
  </nav>
</div>
<header id="header">
  
    
      <img fetchpriority="high" src="https://yangyang666.oss-cn-chengdu.aliyuncs.com/images/Fragment_9_4k_b0d62.jpg" alt="YOLOv8文件分析">
    
  

  <div id="header-outer">
    <div id="header-title">
      
        
        
          
        
  
        
          <a href="/hugo_blog/" id="logo">
            <h1 data-aos="slide-up">YOLOv8文件分析</h1>
          </a>
        
      
  
      
        
        
        <h2 id="subtitle-wrap" data-aos="slide-down">
          
        </h2>
      
    </div>
  </div>
</header>
        <main id="content">
          
            <aside id="sidebar">
  
  
  <div class="sidebar-wrapper wrap-sticky">
    <div
      class="sidebar-wrap"
      data-aos="fade-up"
    >
      
        <div class="sidebar-toc-sidebar">
          <div class="sidebar-toc">
  <h3 class="toc-title">文章目录</h3>
  <div class="sidebar-toc-wrapper toc-div-class">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一本文介绍">一、本文介绍</a></li>
    <li><a href="#二yaml文件的定义">二、yaml文件的定义</a></li>
    <li><a href="#三yaml文件的输入">三、yaml文件的输入 </a>
      <ul>
        <li><a href="#31-模型的定义">3.1 模型的定义</a></li>
        <li><a href="#32-模型的训练">3.2 模型的训练 </a></li>
        <li><a href="#33模型的网络结构打印">3.3 模型的网络结构打印</a></li>
        <li><a href="#34-parse_model的解析">3.4 parse_model的解析</a></li>
      </ul>
    </li>
    <li><a href="#四模型的结构打印">四、模型的结构打印</a></li>
  </ul>
</nav>
  </div>
</div>
        </div>
        <div class="sidebar-common-sidebar hidden">
          
<div class="sidebar-author">
  <img
    data-src="/hugo_blog/avatar/b1.png"
    data-sizes="auto"
    alt="Louaq"
    class="lazyload"
  />
  <div class="sidebar-author-name">Louaq</div>
  <div class="sidebar-description">少女祈祷中...</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>文章</div>
    
    <div class="sidebar-state-number">7</div>
  </div>
  <div class="sidebar-state-category">
    <div>分类</div>
    <div class="sidebar-state-number">
      3
    </div>
  </div>
  <div class="sidebar-state-tag">
    <div>标签</div>
    <div class="sidebar-state-number">6</div>
  </div>
</div>
<div class="sidebar-social">
  
</div>
<div class="sidebar-menu">
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/hugo_blog/"
        aria-label="首页"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>
        
          
            &#xe62b;
          
        
      </div>
      <div class="sidebar-menu-link">首页</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/hugo_blog/archives"
        aria-label="归档"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>
        
          
            &#xe62b;
          
        
      </div>
      <div class="sidebar-menu-link">归档</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/hugo_blog/about"
        aria-label="关于"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>
        
          
            &#xe62b;
          
        
      </div>
      <div class="sidebar-menu-link">关于</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/hugo_blog/friend"
        aria-label="友链"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>
        
          
            &#xe62b;
          
        
      </div>
      <div class="sidebar-menu-link">友链</div>
    </div>
  
</div>

        </div>
      

      
        <div class="sidebar-btn-wrapper" style="position:static">
          <div class="sidebar-toc-btn current"></div>
          <div class="sidebar-common-btn"></div>
        </div>
      
    </div>
  </div>

  <div class="sidebar-widget">
    
  </div>
</aside>

          
          <section id="main">
  <article
  class="h-entry article"
  itemprop="blogPost"
  itemscope
  itemtype="https://schema.org/BlogPosting"
>
  <div
    class="article-inner"
    data-aos="fade-up"
  >
    <div class="article-meta">
      <div class="article-date">
  <a
    href="http://localhost:1313/hugo_blog/post/article_4/"
    class="article-date-link"
    data-aos="zoom-in"
  >
    <time datetime="2024-08-19 12:00:00 &#43;0000 UTC" itemprop="datePublished"
      >2024-08-19</time
    >
    <time style="display: none;" id="post-update-time"
      >2024-08-19</time
    >
  </a>
</div>

      <div class="article-category">
  
    <a
      class="article-category-link"
      href="/hugo_blog/categories/%e5%86%99%e4%bd%9c"
      data-aos="zoom-in"
      >写作</a
    >
  
</div>

    </div>
    <div class="hr-line"></div>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote id="outdate-blockquote" style="display: none;">
          <p></p>
        </blockquote>
      
      
        <h1 id="文件分析">
<a class="header-anchor" href="#%e6%96%87%e4%bb%b6%e5%88%86%e6%9e%90"></a>
文件分析
</h1><h2 id="一本文介绍">
<a class="header-anchor" href="#%e4%b8%80%e6%9c%ac%e6%96%87%e4%bb%8b%e7%bb%8d"></a>
一、本文介绍
</h2><p>本文给大家带来的是<strong>YOLOv8项目的解读</strong>，之前给大家分析了YOLOv8的项目文件分析，这一篇文章给大家带来的是模型训练从我们的yaml文件定义到模型的定义部分的讲解，我们一般只知道如何去训练模型，和配置yaml文件，但是对于yaml文件是如何输入到模型里，模型如何将yaml文件解析出来的确是不知道的，本文的内容接上一篇的代码逐行解析(一) 项目目录分析，本文对于小白来说非常友好，非常推荐大家进行阅读，深度的了解模型的工作原理已经流程，下面我们从yaml文件来讲解。</p>
<p>本文的讲解全部在代码的对应位置进行注释介绍非常详细，<strong>以下为部分内容的截图。</strong></p>
<p><img src="https://yangyang666.oss-cn-chengdu.aliyuncs.com/typoraImages/591c0efe630e4e51b8059bf9e8b197c6.png" alt="591c0efe630e4e51b8059bf9e8b197c6.png"></p>
<p><img src="https://yangyang666.oss-cn-chengdu.aliyuncs.com/typoraImages/af9d4d78be4d448a98554c9265832fb0.png" alt="af9d4d78be4d448a98554c9265832fb0.png"></p>
<hr>
<h2 id="二yaml文件的定义">
<a class="header-anchor" href="#%e4%ba%8cyaml%e6%96%87%e4%bb%b6%e7%9a%84%e5%ae%9a%e4%b9%89"></a>
二、yaml文件的定义
</h2><p>我们训练模型的第一步是需要配置yaml文件，我们的讲解第一步也从yaml文件来开始讲解，YOLOv8的yaml文件存放在我们的如下目录内&rsquo;ultralytics/cfg/models/v8&rsquo;，在其中我们可以定义各种模型配置的文件组合不同的模块，我们拿最基础的YOLOv8yaml文件来讲解一下。</p>
<p><strong>注释部分的内容我就不介绍了，我只介绍一下其中有用的部分，我已经在代码中对应的位置注释上了解释，大家可以看这样看起来也直观一些。</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Ultralytics YOLO 🚀, AGPL-3.0 license</span>
</span></span><span class="line"><span class="cl"><span class="c1"># YOLOv8 object detection model with P3-P5 outputs. For Usage examples see https://docs.ultralytics.com/tasks/detect</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># Parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">nc</span><span class="p">:</span> <span class="mi">80</span>  <span class="c1"># 数据集的类别数，我们默认的数据COCO是80类别（YOLOv8提供的权重也是由此数据集训练出来的），有的读者喜欢修改nc此处其实不需要修改，</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 模型会自动根据我们数据集的yaml文件获取此处的数量，同时我们8.1版本之前的ultralytics仓库打印两边的网络结构，唯一的区别就是nc的数量不一样（实际运行的是第二遍的网络结构）。</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">scales</span><span class="p">:</span>  <span class="c1"># model compound scaling constants, i.e. &#39;model=yolov8n.yaml&#39; will call yolov8.yaml with scale &#39;n&#39;</span>
</span></span><span class="line"><span class="cl">         <span class="c1"># 此处的含义大概就是如果我们在训练的指令时候使用model=yolov8.yaml 则对应的是v8n，如果使用model=yolov8s.yaml则对应的是v8s</span>
</span></span><span class="line"><span class="cl">         <span class="c1"># 当然了大家如果不想使用上面的方式指定模型，我们只需要将下面想要使用的模型移到最前端即可，或者将其余不想用的注释掉都可以。</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1"># [depth, width, max_channels]</span>
</span></span><span class="line"><span class="cl">  <span class="n">n</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">1024</span><span class="p">]</span>  <span class="c1"># YOLOv8n summary: 225 layers,  3157200 parameters,  3157184 gradients,   8.9 GFLOPs</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mi">1024</span><span class="p">]</span>  <span class="c1"># YOLOv8s summary: 225 layers, 11166560 parameters, 11166544 gradients,  28.8 GFLOPs</span>
</span></span><span class="line"><span class="cl">  <span class="n">m</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.67</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">768</span><span class="p">]</span>   <span class="c1"># YOLOv8m summary: 295 layers, 25902640 parameters, 25902624 gradients,  79.3 GFLOPs</span>
</span></span><span class="line"><span class="cl">  <span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mi">512</span><span class="p">]</span>   <span class="c1"># YOLOv8l summary: 365 layers, 43691520 parameters, 43691504 gradients, 165.7 GFLOPs</span>
</span></span><span class="line"><span class="cl">  <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mi">512</span><span class="p">]</span>   <span class="c1"># YOLOv8x summary: 365 layers, 68229648 parameters, 68229632 gradients, 258.5 GFLOPs</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># YOLOv8.0n backbone (主干部分的配置)</span>
</span></span><span class="line"><span class="cl"><span class="n">backbone</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># [from, repeats, module, args]</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 这里需要多介绍一下，from, repeats, module, args</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># from 此处有三种可能的值分别是 -1、具体的数值、list存放数值。分别含义如下  (1)、-1的含义就是代表此层的输入就是上一层的输出，</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#                                                                (2)、如果是具体的某个数字比如4那么则代表本层的输入来自于模型的第四层，</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#                                                                (3)、有的层是list存放两个值也可能是多个值，则代表对应两个值的输出为本层的输入</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># repeats 这个参数是为了C2f设置的其它的模块都用不到，代表着C2f当中Bottleneck重复的次数，比如当我们的模型用的是l的时候，那么repeats=3那么则代表C2f当中的Bottleneck串行3个。</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># module 此处则代表模型的名称</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># args 此处代表输入到对应模块的参数，此处和parse_model函数中的定义方法有关，对于C2f来说传入的参数-&gt;第一个参数是上一个模型的输出通道数，第二个参数就是args的第一个参数，然后以此类推。</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Conv</span><span class="p">,</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>  <span class="c1"># 0-P1/2</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Conv</span><span class="p">,</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>  <span class="c1"># 1-P2/4</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">C2f</span><span class="p">,</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="kc">True</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Conv</span><span class="p">,</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>  <span class="c1"># 3-P3/8</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">C2f</span><span class="p">,</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="kc">True</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Conv</span><span class="p">,</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>  <span class="c1"># 5-P4/16</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">C2f</span><span class="p">,</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="kc">True</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Conv</span><span class="p">,</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>  <span class="c1"># 7-P5/32</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">C2f</span><span class="p">,</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="kc">True</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SPPF</span><span class="p">,</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">5</span><span class="p">]]</span>  <span class="c1"># 9</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># YOLOv8.0n head</span>
</span></span><span class="line"><span class="cl"><span class="n">head</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Concat</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]</span>  <span class="c1"># cat backbone P4</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">C2f</span><span class="p">,</span> <span class="p">[</span><span class="mi">512</span><span class="p">]]</span>  <span class="c1"># 12</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Concat</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]</span>  <span class="c1"># cat backbone P3</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">C2f</span><span class="p">,</span> <span class="p">[</span><span class="mi">256</span><span class="p">]]</span>  <span class="c1"># 15 (P3/8-small)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Conv</span><span class="p">,</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Concat</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]</span>  <span class="c1"># cat head P4</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">C2f</span><span class="p">,</span> <span class="p">[</span><span class="mi">512</span><span class="p">]]</span>  <span class="c1"># 18 (P4/16-medium)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Conv</span><span class="p">,</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Concat</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]</span>  <span class="c1"># cat head P5</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">C2f</span><span class="p">,</span> <span class="p">[</span><span class="mi">1024</span><span class="p">]]</span>  <span class="c1"># 21 (P5/32-large)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="o">-</span> <span class="p">[[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">21</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Detect</span><span class="p">,</span> <span class="p">[</span><span class="n">nc</span><span class="p">]]</span>  <span class="c1"># Detect(P3, P4, P5)</span>
</span></span></code></pre></div><p>其中的Conv和C2f的结构我就不过多解释了，网上教程已经很多了，其中详细的结构在下图中都能够看到。</p>
<p><img src="https://yangyang666.oss-cn-chengdu.aliyuncs.com/typoraImages/de838aaf62ff43df9cf3a6786cb1ec8f.png" alt="de838aaf62ff43df9cf3a6786cb1ec8f.png"></p>
<hr>
<h2 id="三yaml文件的输入">
<a class="header-anchor" href="#%e4%b8%89yaml%e6%96%87%e4%bb%b6%e7%9a%84%e8%be%93%e5%85%a5"></a>
三、yaml文件的输入 
</h2><p>上面我们解释了yaml文件中的参数含义，然后提供了一个结构图（其中能够获取到每个模块的详细结构，该结构图来源于官方）。然后我们下一步介绍当定义好了一个ymal文件其是如何传入到模型的内部的，模型的开始在哪里。</p>
<h3 id="31-模型的定义">
<a class="header-anchor" href="#31-%e6%a8%a1%e5%9e%8b%e7%9a%84%e5%ae%9a%e4%b9%89"></a>
3.1 模型的定义
</h3><p>我们通过命令行的命令或者创建py文件运行模型之后，模型最开始的工作是模型的定义操作。模型存放于文件&rsquo;ultralytics/engine/model.py&rsquo;内部，首先需要通过&rsquo;__init__&lsquo;来定义模型的一些变量。</p>
<p><strong>此处我将模型的定义部分的代码解释了一下，大家有兴趣的可以和自己的文件对比着看。</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        一个统一所有模型API的基类。
</span></span></span><span class="line"><span class="cl"><span class="s2">        参数:
</span></span></span><span class="line"><span class="cl"><span class="s2">            model (str, Path): 要加载或创建的模型文件的路径。
</span></span></span><span class="line"><span class="cl"><span class="s2">            task (Any, 可选): YOLO模型的任务类型。默认为None。
</span></span></span><span class="line"><span class="cl"><span class="s2">        属性:
</span></span></span><span class="line"><span class="cl"><span class="s2">            predictor (Any): 预测器对象。
</span></span></span><span class="line"><span class="cl"><span class="s2">            model (Any): 模型对象。
</span></span></span><span class="line"><span class="cl"><span class="s2">            trainer (Any): 训练器对象。
</span></span></span><span class="line"><span class="cl"><span class="s2">            task (str): 模型任务类型。
</span></span></span><span class="line"><span class="cl"><span class="s2">            ckpt (Any): 如果从*.pt文件加载的模型，则为检查点对象。
</span></span></span><span class="line"><span class="cl"><span class="s2">            cfg (str): 如果从*.yaml文件加载的模型，则为模型配置。
</span></span></span><span class="line"><span class="cl"><span class="s2">            ckpt_path (str): 检查点文件路径。
</span></span></span><span class="line"><span class="cl"><span class="s2">            overrides (dict): 训练器对象的覆盖。
</span></span></span><span class="line"><span class="cl"><span class="s2">            metrics (Any): 用于度量的数据。
</span></span></span><span class="line"><span class="cl"><span class="s2">        方法:
</span></span></span><span class="line"><span class="cl"><span class="s2">            __call__(source=None, stream=False, **kwargs):
</span></span></span><span class="line"><span class="cl"><span class="s2">                预测方法的别名。
</span></span></span><span class="line"><span class="cl"><span class="s2">            _new(cfg:str, verbose:bool=True) -&gt; None:
</span></span></span><span class="line"><span class="cl"><span class="s2">                初始化一个新模型，并从模型定义中推断任务类型。
</span></span></span><span class="line"><span class="cl"><span class="s2">            _load(weights:str, task:str=&#39;&#39;) -&gt; None:
</span></span></span><span class="line"><span class="cl"><span class="s2">                初始化一个新模型，并从模型头中推断任务类型。
</span></span></span><span class="line"><span class="cl"><span class="s2">            _check_is_pytorch_model() -&gt; None:
</span></span></span><span class="line"><span class="cl"><span class="s2">                如果模型不是PyTorch模型，则引发TypeError。
</span></span></span><span class="line"><span class="cl"><span class="s2">            reset() -&gt; None:
</span></span></span><span class="line"><span class="cl"><span class="s2">                重置模型模块。
</span></span></span><span class="line"><span class="cl"><span class="s2">            info(verbose:bool=False) -&gt; None:
</span></span></span><span class="line"><span class="cl"><span class="s2">                记录模型信息。
</span></span></span><span class="line"><span class="cl"><span class="s2">            fuse() -&gt; None:
</span></span></span><span class="line"><span class="cl"><span class="s2">                为了更快的推断，融合模型。
</span></span></span><span class="line"><span class="cl"><span class="s2">            predict(source=None, stream=False, **kwargs) -&gt; List[ultralytics.engine.results.Results]:
</span></span></span><span class="line"><span class="cl"><span class="s2">                使用YOLO模型进行预测。
</span></span></span><span class="line"><span class="cl"><span class="s2">        返回:
</span></span></span><span class="line"><span class="cl"><span class="s2">            list(ultralytics.engine.results.Results): 预测结果。
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;yolov8n.pt&#34;</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Initializes the YOLO model.
</span></span></span><span class="line"><span class="cl"><span class="s2">        Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">            model (Union[str, Path], optional): Path or name of the model to load or create. Defaults to &#39;yolov8n.pt&#39;.
</span></span></span><span class="line"><span class="cl"><span class="s2">            task (Any, optional): Task type for the YOLO model. Defaults to None.
</span></span></span><span class="line"><span class="cl"><span class="s2">            verbose (bool, optional): Whether to enable verbose mode.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        此处为上面的解释
</span></span></span><span class="line"><span class="cl"><span class="s2">               初始化 YOLO 模型。
</span></span></span><span class="line"><span class="cl"><span class="s2">               参数:
</span></span></span><span class="line"><span class="cl"><span class="s2">                   model (Union[str, Path], 可选): 要加载或创建的模型的路径或名称。默认为&#39;yolov8n.pt&#39;。
</span></span></span><span class="line"><span class="cl"><span class="s2">                   task (Any, 可选): YOLO 模型的任务类型。默认为 None。
</span></span></span><span class="line"><span class="cl"><span class="s2">                   verbose (bool, 可选): 是否启用详细模式。
</span></span></span><span class="line"><span class="cl"><span class="s2">               &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;此处就是读取我们的yaml文件的地方，callbacks.get_default_callbacks()会将我们的yaml文件进行解析然后将名称返回回来存放在self.callbacks中&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span><span class="o">.</span><span class="n">get_default_callbacks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; 下面的部分就是一些模型的参数定义，我大概解释了一下，大家其实也不用太了解，一篇文章也介绍不了太多&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 重用预测器</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 模型对象</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 训练器对象</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ckpt</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 如果从*.pt文件加载的检查点对象</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 如果从*.yaml文件加载的模型配置</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_path</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 检查点文件路径</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">overrides</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 训练器对象的覆盖设置</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 验证/训练指标</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># HUB 会话</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>  <span class="c1"># 任务类型</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># 去除空格</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># 检查是否为来自 https://hub.ultralytics.com 的 Ultralytics HUB 模型</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_hub_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 从 HUB 获取模型</span>
</span></span><span class="line"><span class="cl">            <span class="n">checks</span><span class="o">.</span><span class="n">check_requirements</span><span class="p">(</span><span class="s2">&#34;hub-sdk&gt;0.0.2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hub_session</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">model_file</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># 检查是否为 Triton 服务器模型</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_triton_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># 加载或创建新的 YOLO 模型</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">checks</span><span class="o">.</span><span class="n">check_model_file_from_stem</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>  <span class="c1"># 添加后缀，例如 yolov8n -&gt; yolov8n.pt</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; 此处比较重要,如果我们没有指定模型的权重.pt那么模型会根据yaml文件创建一个新的模型，如果指定了权重那么模型这回加载pt文件中的模型&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&#34;.yaml&#34;</span><span class="p">,</span> <span class="s2">&#34;.yml&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span> <span class="c1"># 返回的模型则保存在self.model_name中</span>
</span></span></code></pre></div><hr>
<h3 id="32-模型的训练">
<a class="header-anchor" href="#32-%e6%a8%a1%e5%9e%8b%e7%9a%84%e8%ae%ad%e7%bb%83"></a>
3.2 模型的训练 
</h3><p>我们上面讲完了模型的定义，然后模型就会根据你指定的参数来进行调用对应的函数，比如我这里指定的是detect，和train，如下图所示，然后模型就会根据指定的参数进行对应任务的训练。</p>
<p><strong>图片来源于文件&rsquo;ultralytics/cfg/default.yaml&rsquo; 截图。</strong></p>
<p><img src="https://yangyang666.oss-cn-chengdu.aliyuncs.com/typoraImages/ba833c58a10243b7b3a30fdc9c137c3e.png" alt="ba833c58a10243b7b3a30fdc9c137c3e.png"></p>
<p>此处执行的是ultralytics/engine/model.py&rsquo;文件中class Model(nn.Module):类别的def train(self, trainer=None, **kwargs):函数，具体的解释我已经在代码中标记了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trainer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        在给定的数据集上训练模型。
</span></span></span><span class="line"><span class="cl"><span class="s2">        参数:
</span></span></span><span class="line"><span class="cl"><span class="s2">            trainer (BaseTrainer, 可选): 自定义的训练器。
</span></span></span><span class="line"><span class="cl"><span class="s2">            **kwargs (Any): 表示训练配置的任意数量的参数。
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_check_is_pytorch_model</span><span class="p">()</span>  <span class="c1"># 检查模型是否为 PyTorch 模型</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="s2">&#34;model&#34;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>  <span class="c1"># Ultralytics HUB session with loaded model</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;WARNING ⚠️ 使用 HUB 训练参数，忽略本地训练参数。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">train_args</span>  <span class="c1"># 覆盖 kwargs</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="n">checks</span><span class="o">.</span><span class="n">check_pip_update_available</span><span class="p">()</span>  <span class="c1"># 检查 pip 是否有更新</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="n">overrides</span> <span class="o">=</span> <span class="n">yaml_load</span><span class="p">(</span><span class="n">checks</span><span class="o">.</span><span class="n">check_yaml</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&#34;cfg&#34;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;cfg&#34;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">overrides</span>
</span></span><span class="line"><span class="cl">        <span class="n">custom</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="n">DEFAULT_CFG_DICT</span><span class="p">[</span><span class="s2">&#34;data&#34;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">TASK2DATA</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">]}</span>  <span class="c1"># 方法的默认设置</span>
</span></span><span class="line"><span class="cl">        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">overrides</span><span class="p">,</span> <span class="o">**</span><span class="n">custom</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="s2">&#34;mode&#34;</span><span class="p">:</span> <span class="s2">&#34;train&#34;</span><span class="p">}</span>  <span class="c1"># 最高优先级的参数在右侧</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;resume&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span><span class="p">[</span><span class="s2">&#34;resume&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_path</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># 实例化或加载训练器</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; 此处将一些参数加载到模型的内部&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="p">(</span><span class="n">trainer</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smart_load</span><span class="p">(</span><span class="s2">&#34;trainer&#34;</span><span class="p">))(</span><span class="n">overrides</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">_callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;resume&#34;</span><span class="p">):</span>  <span class="c1"># 仅在不续训的时候手动设置模型</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 获取模型并设置训练器</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            此处比较重要,为开始定义我们的对应任务的模型了比如我这里task设置的为Detect,那么此处会实例化DetectModel模型。
</span></span></span><span class="line"><span class="cl"><span class="s2">            模型存放在ultralytics/nn/tasks.py内（就是我们修改模型时候的用到的那个task.py文件）
</span></span></span><span class="line"><span class="cl"><span class="s2">            此处就会跳转到&#39;ultralytics/nn/tasks.py&#39;文化内的class DetectionModel(BaseModel):类中进行初始化和模型的定义工作
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ckpt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">yaml</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">SETTINGS</span><span class="p">[</span><span class="s2">&#34;hub&#34;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 如果开启了 HUB 并且没有 HUB 会话</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 创建一个 HUB 中的模型</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hub_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># 检查模型是否创建成功</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="p">(</span><span class="ne">PermissionError</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 忽略 PermissionError 和 ModuleNotFoundError，表示 hub-sdk 未安装</span>
</span></span><span class="line"><span class="cl">                    <span class="k">pass</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># 将可选的 HUB 会话附加到训练器</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">hub_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># 进行模型训练</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># 训练结束后更新模型和配置信息</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">RANK</span> <span class="ow">in</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">ckpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">best</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">best</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">last</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">attempt_load_one_weight</span><span class="p">(</span><span class="n">ckpt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">overrides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">args</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">validator</span><span class="p">,</span> <span class="s2">&#34;metrics&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># TODO: DDP 模式下没有返回指标</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>
</span></span></code></pre></div><hr>
<h3 id="33模型的网络结构打印">
<a class="header-anchor" href="#33%e6%a8%a1%e5%9e%8b%e7%9a%84%e7%bd%91%e7%bb%9c%e7%bb%93%e6%9e%84%e6%89%93%e5%8d%b0"></a>
3.3 模型的网络结构打印
</h3><p>第三步比较重要的就是来到了&rsquo;ultralytics/nn/tasks.py&rsquo;（就是我们改进模型时候的那个文件）文化内的class DetectionModel(BaseModel):类中进行初始化和模型的定义工作。</p>
<p>这里涉及到了模型的定义和校验工作（在模型的正式开始训练之前检测模型是否能够运行的工作！）。 </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DetectionModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;YOLOv8 目标检测模型。&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="s2">&#34;yolov8n.yaml&#34;</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># model, input channels, number of classes</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;使用给定的配置和参数初始化 YOLOv8 目标检测模型。&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span> <span class="o">=</span> <span class="n">cfg</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">yaml_model_load</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>  <span class="c1"># cfg 字典</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># 定义模型</span>
</span></span><span class="line"><span class="cl">        <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">[</span><span class="s2">&#34;ch&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;ch&#34;</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>  <span class="c1"># 输入通道数</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">nc</span> <span class="ow">and</span> <span class="n">nc</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">[</span><span class="s2">&#34;nc&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;覆盖 model.yaml nc=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> 为 nc=</span><span class="si">{</span><span class="n">nc</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">[</span><span class="s2">&#34;nc&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nc</span>  <span class="c1"># 覆盖 YAML 中的值</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; 此处最为重要，涉及到了我们修改模型的配置的那个函数parse_model,
</span></span></span><span class="line"><span class="cl"><span class="s2">            这里返回了我们的每一个模块的定义，也就是self.model保存了我们的ymal文件所有模块的实例化模型
</span></span></span><span class="line"><span class="cl"><span class="s2">            self.save保存列表 | 也就是除了from部分为-1的部分比如from为4那么就将第四层的索引保存这里留着后面备用，
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">parse_model</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">),</span> <span class="n">ch</span><span class="o">=</span><span class="n">ch</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>  <span class="c1"># 模型，保存列表</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">[</span><span class="s2">&#34;nc&#34;</span><span class="p">])}</span>  <span class="c1"># 默认名称字典</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">inplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;inplace&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># 构建步长</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Detect()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="n">Detect</span><span class="p">,</span> <span class="n">Segment</span><span class="p">,</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">Detect_AFPN4</span><span class="p">,</span> <span class="n">Detect_AFPN3</span><span class="p">,</span> <span class="n">Detect_ASFF</span><span class="p">,</span> <span class="n">Detect_FRM</span><span class="p">,</span> <span class="n">Detect_dyhead</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">CLLAHead</span><span class="p">,</span> <span class="n">Detect_dyhead3</span><span class="p">,</span> <span class="n">Detect_DySnakeConv</span><span class="p">,</span> <span class="n">Segment_DySnakeConv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">Segment_DBB</span><span class="p">,</span> <span class="n">Detect_DBB</span><span class="p">,</span> <span class="n">Pose_DBB</span><span class="p">,</span> <span class="n">OBB</span><span class="p">,</span> <span class="n">Detect_FASFF</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span> <span class="o">=</span> <span class="mi">640</span>  <span class="c1"># 2x 最小步长</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span><span class="o">.</span><span class="n">inplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inplace</span>
</span></span><span class="line"><span class="cl">            <span class="n">forward</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="n">Segment</span><span class="p">,</span> <span class="n">Segment_DySnakeConv</span><span class="p">,</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">Pose_DBB</span><span class="p">,</span> <span class="n">Segment_DBB</span><span class="p">,</span> <span class="n">OBB</span><span class="p">))</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">m</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">s</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">forward</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">))])</span>  <span class="c1"># 在 CPU 上进行前向传播</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="n">m</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">s</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">forward</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)))])</span>  <span class="c1"># 在 CUDA 上进行前向传播</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">raise</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">stride</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span><span class="o">.</span><span class="n">bias_init</span><span class="p">()</span>  <span class="c1"># 仅运行一次</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">32</span><span class="p">])</span>  <span class="c1"># 默认步长，例如 RTDETR</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># 初始化权重和偏置</span>
</span></span><span class="line"><span class="cl">        <span class="n">initialize_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="c1"># 此处为获取模型参数量和打印的地方。</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span></code></pre></div><hr>
<h3 id="34-parse_model的解析">
<a class="header-anchor" href="#34-parse_model%e7%9a%84%e8%a7%a3%e6%9e%90"></a>
3.4 parse_model的解析
</h3><p>这里涉及到yaml文件中模块的定义和，通道数放缩的地方，此处大家可以仔细看看比较重要涉及到模块的改动。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_model</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># model_dict, input_channels(3)</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;解析 YOLO 模型.yaml 字典为 PyTorch 模型。&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">ast</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1"># 参数设置</span>
</span></span><span class="line"><span class="cl">    <span class="n">max_channels</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&#34;inf&#34;</span><span class="p">)</span> <span class="c1"># 设置一个最大的通道数inf,防止后面的通道数有的超出了范围，没什么作用其实。</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;下面一行代码比较重要，为获取我们yaml文件中的参数,nc=类别数（前面解释过了） act=激活函数， scales=模型的大小&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nc</span><span class="p">,</span> <span class="n">act</span><span class="p">,</span> <span class="n">scales</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&#34;nc&#34;</span><span class="p">,</span> <span class="s2">&#34;activation&#34;</span><span class="p">,</span> <span class="s2">&#34;scales&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;此处为获取模型的通道数放缩比例假如  n: [0.33, 0.25, 1024]  # YOLOv8n summary: 225 layers,  3157200 parameters,  3157184 gradients,   8.9 GFLOPs&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;那么此处对应的就是 0.33 , 0.25, 1024&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">depth</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">kpt_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&#34;depth_multiple&#34;</span><span class="p">,</span> <span class="s2">&#34;width_multiple&#34;</span><span class="p">,</span> <span class="s2">&#34;kpt_shape&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;下面这个判断主要的功能就是我们指定yaml文件的时候如果不指定n或者其它模型尺度则默认用n然后提出一个警告，细心的读者应该会遇到过这个警告，群里也有人问过&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">scales</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">scale</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;scale&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">scale</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">scale</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">scales</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;WARNING ⚠️ 没有传递模型比例。假定 scale=&#39;</span><span class="si">{</span><span class="n">scale</span><span class="si">}</span><span class="s2">&#39;。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">depth</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">max_channels</span> <span class="o">=</span> <span class="n">scales</span><span class="p">[</span><span class="n">scale</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">act</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">Conv</span><span class="o">.</span><span class="n">default_act</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>  <span class="c1"># 重新定义默认激活函数，例如 Conv.default_act = nn.SiLU()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">colorstr</span><span class="p">(</span><span class="s1">&#39;activation:&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">act</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  <span class="c1"># 打印</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="si">:</span><span class="s2">&gt;3</span><span class="si">}{</span><span class="s1">&#39;from&#39;</span><span class="si">:</span><span class="s2">&gt;20</span><span class="si">}{</span><span class="s1">&#39;n&#39;</span><span class="si">:</span><span class="s2">&gt;3</span><span class="si">}{</span><span class="s1">&#39;params&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="s1">&#39;module&#39;</span><span class="si">:</span><span class="s2">&lt;45</span><span class="si">}{</span><span class="s1">&#39;arguments&#39;</span><span class="si">:</span><span class="s2">&lt;30</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ch</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="c1"># 存放第一个输入的通道数,这个ch后面会存放所有层的通道数，第一层为通道数是ch=3也就是对应我们一张图片的RGB图片的三基色三个通道，分别对应红绿蓝！</span>
</span></span><span class="line"><span class="cl">    <span class="n">layers</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">ch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 提前定义一些之后存放的容器分别为，模型层，保存列表，输出通道数</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;下面开始正式解析模型的yaml文件然后进行定义的操作用for训练便利yaml文件&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&#34;backbone&#34;</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="s2">&#34;head&#34;</span><span class="p">]):</span>  <span class="c1"># from, number, module, args</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span> <span class="k">if</span> <span class="s2">&#34;nn.&#34;</span> <span class="ow">in</span> <span class="n">m</span> <span class="k">else</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">m</span><span class="p">]</span>  <span class="c1"># 获取模块</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">args</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">a</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; 此处为repeat那个参数的放缩操作,不过多解释了,最小的n是1（就是是说你yaml文件里定义的是3，然后和放缩系数相乘然后和1比那个小取那个）&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">=</span> <span class="n">n_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">depth</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;下面是一些具体模块的定义操作了&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Classify</span><span class="p">,</span> <span class="n">Conv</span><span class="p">,</span> <span class="n">ConvTranspose</span><span class="p">,</span> <span class="n">GhostConv</span><span class="p">,</span> <span class="n">Bottleneck</span><span class="p">,</span> <span class="n">GhostBottleneck</span><span class="p">,</span> <span class="n">SPP</span><span class="p">,</span> <span class="n">SPPF</span><span class="p">,</span> <span class="n">DWConv</span><span class="p">,</span> <span class="n">Focus</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">BottleneckCSP</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">C2f</span><span class="p">,</span> <span class="n">C2fAttn</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C3TR</span><span class="p">,</span> <span class="n">C3Ghost</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">,</span> <span class="n">DWConvTranspose2d</span><span class="p">,</span> <span class="n">C3x</span><span class="p">,</span> <span class="n">RepC3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">ch</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">c2</span> <span class="o">!=</span> <span class="n">nc</span><span class="p">:</span>  <span class="c1"># 如果 c2 不等于类别数（即 Classify() 输出）</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;&#34;&#34; 绝大多数情况下都不等，我们放缩通道数，也就是为什么不同大小的模型参数量不一致的地方因为参数量主要由通道数决定，GFLOPs主要有图像的宽和高决定&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">c2</span> <span class="o">=</span> <span class="n">make_divisible</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">max_channels</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">C2fAttn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_divisible</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">max_channels</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>  <span class="c1"># 嵌入通道数</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">max_channels</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">//</span> <span class="mi">32</span><span class="p">))</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>  <span class="c1"># 头部数量</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#34;&#34;此处需要解释一下，大家需要仔细注意此处&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#34;&#34; 这个args就是传入到我们模型的参数,C1就是上一层的或者指定层的输出的通道数，C2就是本层的输出通道数， *args[1:]就是其它的一些参数比如卷积核步长什么的&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#34;&#34; 此处和注意力机制不同的是，为什么注意力机制不在此处添加因为注意力机制不改变模型的维度，所以一般只需要指定一个输入通道数就行，
</span></span></span><span class="line"><span class="cl"><span class="s2">                所以这也是为什么我们在后面定义注意力需要额外添加代码的原因有兴趣的读者可以对比一下&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#34;&#34; 此处就是涉及的上面求出的实际的n然后插入的参数列表中去，然后准备在最下面进行传参&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">BottleneckCSP</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">C2f</span><span class="p">,</span> <span class="n">C2fAttn</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C3TR</span><span class="p">,</span> <span class="n">C3Ghost</span><span class="p">,</span> <span class="n">C3x</span><span class="p">,</span> <span class="n">RepC3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># 重复次数</span>
</span></span><span class="line"><span class="cl">                <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;这些都是一些具体的模块定义的方法，不多解释了&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">AIFI</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">HGStem</span><span class="p">,</span> <span class="n">HGBlock</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">c1</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">ch</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">c1</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">HGBlock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># 重复次数</span>
</span></span><span class="line"><span class="cl">                <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">ResNetLayer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">c2</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span><span class="p">[</span><span class="n">f</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">Concat</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">c2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Detect</span><span class="p">,</span> <span class="n">WorldDetect</span><span class="p">,</span> <span class="n">Segment</span><span class="p">,</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">OBB</span><span class="p">,</span> <span class="n">ImagePoolingAttn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ch</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">Segment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_divisible</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">max_channels</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">RTDETRDecoder</span><span class="p">:</span>  <span class="c1"># 特殊情况，channels 参数必须在索引 1 中传递</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">ch</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">c2</span> <span class="o">=</span> <span class="n">ch</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;此处就是模型的正式定义和传参的操作&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">m</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># 模块</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)[</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;__main__.&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>  <span class="c1"># 模块类型</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span><span class="o">.</span><span class="n">np</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m_</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>  <span class="c1"># 参数数量</span>
</span></span><span class="line"><span class="cl">        <span class="n">m_</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">m_</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="n">m_</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">t</span>  <span class="c1"># 附加索引，&#39;from&#39; 索引，类型</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">&gt;3</span><span class="si">}{</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;20</span><span class="si">}{</span><span class="n">n_</span><span class="si">:</span><span class="s2">&gt;3</span><span class="si">}{</span><span class="n">m</span><span class="o">.</span><span class="n">np</span><span class="si">:</span><span class="s2">10.0f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s2">&lt;45</span><span class="si">}{</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">:</span><span class="s2">&lt;30</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>  <span class="c1"># 打印</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;此处就是保存一些索引通道数涉及到from的部分，此处文字很难解释的清楚有兴趣可以自己debug看一下就明白了&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">save</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">([</span><span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 添加到保存列表</span>
</span></span><span class="line"><span class="cl">        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ch</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">ch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">save</span><span class="p">)</span>
</span></span></code></pre></div><hr>
<h2 id="四模型的结构打印">
<a class="header-anchor" href="#%e5%9b%9b%e6%a8%a1%e5%9e%8b%e7%9a%84%e7%bb%93%e6%9e%84%e6%89%93%e5%8d%b0"></a>
四、模型的结构打印
</h2><p>经过上面的分析之后，我们就会打印了模型的结构，图片如下所示，然后到此本篇文章的分析就到这里了，剩下的下一篇文章讲解。</p>
<p><strong>（需要注意的是上面的讲解整体是按照顺序但是是以递归的形式介绍，比如3.2是3.1当中的某一行代码的功能而不是结束之后才允许的3.2，而是3.1运行的过程中运行了3.2。）</strong></p>
<p><img src="https://yangyang666.oss-cn-chengdu.aliyuncs.com/typoraImages/d3d9d7580362433ba08904db10be9ea4.png" alt="d3d9d7580362433ba08904db10be9ea4.png"></p>

      
    </div>
    <footer class="article-footer">
      
        






<blockquote class="article-copyright">
  
    <p><strong>本文作者：</strong>Louaq @ Louaq lab</p>
  
  
    <p>
      <strong>本文链接：</strong><a href="http://localhost:1313/hugo_blog/post/article_4/">http://localhost:1313/hugo_blog/post/article_4/</a>
    </p>
  
  
  
  
  
    <p>
      <strong>本文版权：</strong>本博客所有文章除特别声明外，均采用
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"
        ><span class="icon-creative-commons"></span>BY-NC-SA</a
      >
      许可协议。转载请注明出处！
    </p>
    <span class="icon-creative-commons article-copyright-bg"></span>
  
</blockquote>

      

      

      
        <a
          data-aos="zoom-in"
          href="http://localhost:1313/hugo_blog/post/article_4/#comments"
          class="article-comment-link"
        >
          <span
            class="post-comments-count valine-comment-count"
            data-xid="http//localhost1313/hugo_blog/post/article_4/"
            itemprop="commentCount"
          ></span>
          留言
        </a>
      

      

      

      
        <span
          data-aos="zoom-in"
          id="/hugo_blog/post/article_4/"
          class="leancloud_visitors article-visitor-link"
          data-flag-title="YOLOv8文件分析"
        >
          <span class="leancloud-visitors-count">0</span>
          <em class="post-meta-item-text">阅读量</em>
        </span>
      

      
      <ul class="article-tag-list" itemprop="keywords">
  
</ul>

    </footer>
  </div>
  
    
  <nav
    id="article-nav"
    data-aos="fade-up"
  >
    
      <div class="article-nav-link-wrap article-nav-link-left">
        
          <img
            data-src="https://yangyang666.oss-cn-chengdu.aliyuncs.com/images/%E6%8A%A5%E7%BA%B8%E5%A2%99%E5%8F%AF%E7%88%B1%E5%A5%B3%E5%AD%A9%E8%90%A8%E5%8B%92%E8%8A%AC%E5%A6%AE4K%E5%A3%81%E7%BA%B83840_2400_%E5%BD%BC%E5%B2%B8%E5%9B%BE%E7%BD%91.jpg"
            data-sizes="auto"
            alt="说明文档"
            class="lazyload"
          />
        
        <a href="http://localhost:1313/hugo_blog/post/%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/"></a>
        <div class="article-nav-caption">前一篇</div>
        <h3 class="article-nav-title">
          
            说明文档
          
        </h3>
      </div>
    

    
      <div class="article-nav-link-wrap article-nav-link-right">
        
          <img
            data-src="https://yangyang666.oss-cn-chengdu.aliyuncs.com/images/1.%E7%B4%AB%E7%81%B5%20%E5%87%A1%E4%BA%BA%E4%BF%AE%E4%BB%99%E4%BC%A0.jpeg"
            data-sizes="auto"
            alt="vscode配置latex环境"
            class="lazyload"
          />
        
        <a href="http://localhost:1313/hugo_blog/post/visual-studio-code-/"></a>
        <div class="article-nav-caption">后一篇</div>
        <h3 class="article-nav-title">
          
            vscode配置latex环境
          
        </h3>
      </div>
    
  </nav>


  
</article>

  <section
    id="comments"
    class="vcomment"
    data-aos="fade-up"
  ></section>










</section>
          
        </main>
        



  
  

  
  

  
  

  
  

  
  

  
  

  
  



<footer id="footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info">
    <div>
      <span class="icon-copyright"></span>
      2024 -
      2025
      <span class="footer-info-sep rotate"></span>
      Louaq
    </div>
    
      <div>
        基于&nbsp;<a
          href="https://gohugo.io/"
          target="_blank"
          >Hugo</a
        >&nbsp; Theme.<a
          href="https://github.com/D-Sketon/hugo-theme-reimu"
          target="_blank"
          >Reimu</a
        >
      </div>
    
    
      <div>
        <span class="icon-brush"
          >&nbsp;
            4.9k
          </span
        >
        &nbsp;|&nbsp;
        <span class="icon-coffee">&nbsp;
          
          

          00:27
        </span>
      </div>
    
    
    
    
      <div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv"
          >总访问量&nbsp;<span
            id="busuanzi_value_site_pv"
          ></span
        ></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv"
          >总访客量&nbsp;<span
            id="busuanzi_value_site_uv"
          ></span
        ></span>
      </div>
    
  </div>
</footer>

        
          <div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div>
        
        <div id="mask" class="hide"></div>
      </div>
      <nav id="mobile-nav">
  <div class="sidebar-wrap">
    
      <div class="sidebar-toc-sidebar">
        <div class="sidebar-toc">
  <h3 class="toc-title">文章目录</h3>
  <div class="sidebar-toc-wrapper toc-div-class">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一本文介绍">一、本文介绍</a></li>
    <li><a href="#二yaml文件的定义">二、yaml文件的定义</a></li>
    <li><a href="#三yaml文件的输入">三、yaml文件的输入 </a>
      <ul>
        <li><a href="#31-模型的定义">3.1 模型的定义</a></li>
        <li><a href="#32-模型的训练">3.2 模型的训练 </a></li>
        <li><a href="#33模型的网络结构打印">3.3 模型的网络结构打印</a></li>
        <li><a href="#34-parse_model的解析">3.4 parse_model的解析</a></li>
      </ul>
    </li>
    <li><a href="#四模型的结构打印">四、模型的结构打印</a></li>
  </ul>
</nav>
  </div>
</div>
      </div>
      <div class="sidebar-common-sidebar hidden">
        
<div class="sidebar-author">
  <img
    data-src="/hugo_blog/avatar/b1.png"
    data-sizes="auto"
    alt="Louaq"
    class="lazyload"
  />
  <div class="sidebar-author-name">Louaq</div>
  <div class="sidebar-description">少女祈祷中...</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>文章</div>
    
    <div class="sidebar-state-number">7</div>
  </div>
  <div class="sidebar-state-category">
    <div>分类</div>
    <div class="sidebar-state-number">
      3
    </div>
  </div>
  <div class="sidebar-state-tag">
    <div>标签</div>
    <div class="sidebar-state-number">6</div>
  </div>
</div>
<div class="sidebar-social">
  
</div>
<div class="sidebar-menu">
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/hugo_blog/"
        aria-label="首页"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>
        
          
            &#xe62b;
          
        
      </div>
      <div class="sidebar-menu-link">首页</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/hugo_blog/archives"
        aria-label="归档"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>
        
          
            &#xe62b;
          
        
      </div>
      <div class="sidebar-menu-link">归档</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/hugo_blog/about"
        aria-label="关于"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>
        
          
            &#xe62b;
          
        
      </div>
      <div class="sidebar-menu-link">关于</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/hugo_blog/friend"
        aria-label="友链"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>
        
          
            &#xe62b;
          
        
      </div>
      <div class="sidebar-menu-link">友链</div>
    </div>
  
</div>

      </div>
    
  </div>
  
    <div class="sidebar-btn-wrapper">
      <div class="sidebar-toc-btn current"></div>
      <div class="sidebar-common-btn"></div>
    </div>
  
</nav>

    </div>
    
      <div class="site-search">
        <div class="reimu-popup popup">
          <div class="reimu-search">
            <div class="reimu-search-input-icon"></div>
            <div class="reimu-search-input" id="reimu-search-input"></div>
            <div class="popup-btn-close"></div>
          </div>
          <div class="reimu-results">
            <div id="reimu-stats"></div>
            <div id="reimu-hits"></div>
            <div id="reimu-pagination" class="reimu-pagination"></div>
          </div>
          <img class="reimu-bg" src="/hugo_blog/images/reimu.png" />
        </div>
      </div>
    
    






  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js"
    
    
    
    
    integrity="sha384-3gT/vsepWkfz/ff7PpWNUeMzeWoH3cDhm/A8jM7ouoAK0/fP/9bcHHR5kHq2nf&#43;e" crossorigin="anonymous"
  ></script>




  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js"
    
    
    
    
    integrity="sha384-J08i8An/QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"
  ></script>









  
      
      <script src="/hugo_blog/js/main.js" ></script>
      



  





  
      
      <script src="/hugo_blog/js/aos.js" ></script>
      

  <script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", aosInit);
    } else {
      aosInit();
    }
  </script>








  
      
      <script src="/hugo_blog/js/pjax_main.js" data-pjax></script>
      



  <script>
    var ALGOLIA_CONFIG = {
      logo: '\/hugo_blog\/images\/algolia_logo.svg',
      algolia: {
        applicationID: "NDK8J4UYWP",
        apiKey: "3391326455879dbb1169634857165c34",
        indexName: "reimu",
        hits: {
          "per_page": parseInt("10")
        },
        labels: {
          "input_placeholder": "搜索.....",
          "hits_empty": "未发现与 「${query}」相关内容",
          "hits_stats": "找到${hits}条结果（用时 ${time} ms）"
        }
      }
    };
  </script>
  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/algoliasearch@4.17.1/dist/algoliasearch-lite.umd.js"
    defer
    
    
    
    integrity="sha384-xvLS0jfKuoREs7pqkRI/OI8GcqohO5S&#43;jQz7ZBtQXnsXmD&#43;9jDOOY4cL6dCPzlrk" crossorigin="anonymous"
  ></script>


  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/instantsearch.js@4.56.1/dist/instantsearch.production.min.js"
    defer
    
    
    
    integrity="sha384-hHJCflT4KBLQyHfKO9vpstIcFKn/Y&#43;KHTORelMMEn7mOp2AVPp&#43;7fr03dLgZiV3J" crossorigin="anonymous"
  ></script>


  





  
      
      <script src="/hugo_blog/js/algolia_search.js" ></script>
      










  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/quicklink@2.3.0/dist/quicklink.umd.js"
    
    
    
    
    integrity="sha384-aD7FsuQkS1ohgFKY41fJfeA&#43;Wd/QRNnrOd9Bs58K3FzKdJJv8yPnYU8Tnp5z1agS" crossorigin="anonymous"
  ></script>


  <script data-pjax>
    window.quicklink?.listen({
      timeout:  3000 ,
      priority:  true ,
      ignores: JSON.parse("[]")
    });
  </script>


<div id="lazy-script">
  <div>
    
    
      





  
      
      <script src="/hugo_blog/js/insert_highlight.js" data-pjax></script>
      

      
      
      
      
      <script type="module" data-pjax>
        const PhotoSwipeLightbox = (await safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe-lightbox.esm.min.js", "sha384-DiL6M\/gG\u002bwmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF\/N6lrZi\/")).default;

        const pswp = () => {
          if (_$$('.article-entry a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-entry',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")
            }).init();
          }
          if(_$$('.article-gallery a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-gallery',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")
            }).init();
          }
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script>
      




  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/valine@1.5.1/dist/Valine.min.js"
    
    
    data-pjax
    
    integrity="sha384-3ma91AExDeMAZ1rjTjaP8V2A2obQE&#43;s5ltKRwYlwdpArz9xVbp0tF3b0VV2ACNPn" crossorigin="anonymous"
  ></script>


  <script data-pjax>
    var GUEST_INFO = ['nick', 'mail', 'link'];
    var guest_info = 'nick,mail,link'.split(',').filter((item) => {
      return GUEST_INFO.indexOf(item) > -1
    });
    var recordIP = JSON.parse('true');
    var highlight = JSON.parse('true');
    var visitor = JSON.parse('true');

    new Valine({
      el: '.vcomment',
      appId: "0Mjc3mdBrN8OYovk9yaFnaWO-gzGzoHsz",
      appKey: "VNEmZEAvagCiszqPZ3JFfVI4VNEmZEAvagCiszqPZ3JFfVI4",
      placeholder: "Just go go",
      pageSize: '10',
      avatar: 'mp',
      lang: 'zh-cn',
      recordIP: recordIP,
      highlight: highlight,
      visitor: visitor,
      requiredFields: guest_info,
      path: window.location.pathname
    });
  </script>









    
    
  </div>
</div>


  <script data-pjax>
    var updateTime = _$('#post-update-time')?.innerHTML;

    if (updateTime) {
      const update = new Date(updateTime);
      const now = new Date();
      const diff = now - update;
      const days = diff / 86400000;
      const { daysago: daysAgo, message: template } = window.siteConfig.outdate;
      if (days >= daysAgo) {
        const message = template.replace(/{time}/, updateTime);
        const blockquote = _$('#outdate-blockquote');
        if (blockquote) {
          blockquote.querySelector('p').innerText = message;
          blockquote.style.display = 'block';
        }
      }
    }
  </script>



  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js"
    
    async
    
    
    integrity="sha384-0M75wtSkhjIInv4coYlaJU83&#43;OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id&#43;S" crossorigin="anonymous"
  ></script>





  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then((registrations) => {
        for (let registration of registrations) {
          registration.unregister();
        }
      });
    }
  </script>


<script>
  const reimuCopyright = String.raw`
   ______     ______     __     __    __     __  __    
  /\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
  \ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
   \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
    \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                    
  `;
  console.log(String.raw`%c ${reimuCopyright}`, "color: #ff5252;");
  console.log(
    "%c Theme.Reimu" + " %c https://github.com/D-Sketon/hugo-theme-reimu ",
    "color: white; background: #ff5252; padding:5px 0;",
    "padding:4px;border:1px solid #ff5252;",
  );
</script>




  </body>
</html>
